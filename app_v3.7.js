(async function(){function nowStr(){const d=new Date();return d.toLocaleDateString()+' '+d.toLocaleTimeString()}const nowEl=document.getElementById('now');function setNow(){nowEl.innerText=nowStr()}setNow();setInterval(setNow,1000);const typeSelect=document.getElementById('typeSelect');const regionSelect=document.getElementById('regionSelect');const rodoviaSelect=document.getElementById('rodoviaSelect');const searchInput=document.getElementById('searchInput');const newsList=document.getElementById('newsList');const lastFetch=document.getElementById('lastFetch');const dnit=await fetch('data/dnit_br_list.json').then(r=>r.json()).catch(()=>[]);const conc=await fetch('data/concessionarias.json').then(r=>r.json()).catch(()=>[]);const mock=await fetch('data/mock_data.json').then(r=>r.json()).catch(()=>[]);const customRodovias=["BR-381/MG/SP","BR-101/RJ","BR-376/PR - BR-101/SC","BR-116/PR/SC","BR-116/SP/PR","BR-060/153/262/DF/GO/MG","BR-040/MG/RJ","BR-116/RJ","BR-101/ES/BA","BR-101/RJ","BR-116/293/RS","BR-050/GO/MG","BR-163/MS","BR-116/RJ/SP","BR-393/RJ","BR-163/MT","BR-153/SP","BR-040/DF/GO/MG","BR-116/324/BA","BR-101/290/386/448/RS"];rodoviaSelect.innerHTML='<option value="">Todas</option>';customRodovias.forEach(r=>rodoviaSelect.innerHTML+=`<option value="${r}">${r}</option>`);document.getElementById('concessList').innerHTML=conc.map(c=>`<div class="concess" data-site="${c.site}" style="cursor:pointer"><strong>${c.concessionaria}</strong><div style="font-size:13px">${c.rodovias} ‚Äî ${c.extensao_km} km</div></div>`).join('');document.getElementById('concessList').addEventListener('click',function(e){const el=e.target.closest('.concess');if(el&&el.dataset.site)window.open(el.dataset.site,'_blank');});const typesCtx=document.getElementById('chartTypes').getContext('2d');const regionsCtx=document.getElementById('chartRegions').getContext('2d');const chartTypes=new Chart(typesCtx,{type:'bar',data:{labels:[],datasets:[{label:'Ocorr√™ncias',data:[],backgroundColor:'#0d47a1'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});const chartRegions=new Chart(regionsCtx,{type:'doughnut',data:{labels:[],datasets:[{data:[],backgroundColor:['#0d47a1','#1976d2','#42a5f5','#90caf9','#64b5f6']}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom'}}}});const map=L.map('map',{scrollWheelZoom:false}).setView([-14.2350,-51.9253],4);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);const markers=L.layerGroup().addTo(map);function detectType(text){text=(text||'').toLowerCase();if(/acidente|capot|colis/i.test(text))return'Acidente';if(/roubo|assalto/i.test(text))return'Roubo';if(/furto/i.test(text))return'Furto';if(/interdi|bloqueio|obra|manuten/i.test(text))return'Interdi√ß√£o';if(/porto|navio|mar√≠tim/i.test(text))return'Portos/Mar√≠timos';if(/sindicat|greve/i.test(text))return'Sindicatos/Greves';if(/tr√¢nsito|transito|lentid√£o/i.test(text))return'Tr√°fego';return'Outros'}function detectRoad(text){const m=(text||'').match(/BR[-\s]?\d{1,4}/i);return m?m[0].toUpperCase().replace(' ','-'):''}function detectRegion(text){text=(text||'').toLowerCase();if(/acre|amas?zonas|roraima|rondonia|para\b|amapa/i.test(text))return'Norte';if(/bahia|sergipe|alagoas|paraiba|pernambuco|ceara|maranhao|maranh[a√£]/i.test(text))return'Nordeste';if(/goias|goi[a√°]s|mato grosso do sul|mato grosso|distrito federal|df/i.test(text))return'Centro-Oeste';if(/s[o√£]o paulo|sao paulo|minas gerais|rio de janeiro|espirito santo|esp√≠rito santo/i.test(text))return'Sudeste';if(/paran[a√°]|santa catarina|rio grande do sul/i.test(text))return'Sul';return'Outras'}async function fetchFeeds(){let items=[];try{items=await fetch('data/mock_data.json').then(r=>r.json());}catch(e){items=[];}const usedSources=new Set();items=items.map(it=>{it.type=it.type||detectType(it.title+' '+it.snippet);it.road=it.road||detectRoad(it.title+' '+it.snippet);it.region=it.region||detectRegion(it.title+' '+it.snippet);usedSources.add(it.source||'Desconhecida');return it;});localStorage.setItem('congrl_used_sources',JSON.stringify(Array.from(usedSources)));return items.sort((a,b)=>new Date(b.pubDate).getTime()-new Date(a.pubDate).getTime());}function renderNews(list){newsList.innerHTML='';list.forEach(it=>{const time=new Date(it.pubDate);const timestr=time.toLocaleDateString()+' '+time.toLocaleTimeString();const icon=it.type==='Acidente'?'üöó':(it.type==='Interdi√ß√£o'?'üöß':(it.type==='Roubo'?'üö®':(it.type==='Furto'?'‚ö™':'‚ö†Ô∏è')));const div=document.createElement('div');div.className='news-item';div.innerHTML=`<div class="icon">${icon}</div><div style="flex:1;min-width:220px"><span class="meta">[${it.type}] ‚Äî ${it.road? it.road + ' ‚Äî ' : ''}</span> <a href="${it.link}" target="_blank">${it.title}</a></div><div class="meta">${it.source} | ${timestr}</div>`;div.addEventListener('click',()=>{if(it.lat&&it.lon){map.setView([it.lat,it.lon],11);L.popup().setLatLng([it.lat,it.lon]).setContent(`<strong>${it.title}</strong><br>${it.source}`).openOn(map);}});newsList.appendChild(div);});}function updateStats(list){document.getElementById('statAcc').innerText=list.filter(i=>i.type==='Acidente').length;document.getElementById('statInt').innerText=list.filter(i=>i.type==='Interdi√ß√£o'||i.type==='Tr√¢nsito').length;document.getElementById('statRoubo').innerText=list.filter(i=>i.type==='Roubo').length;document.getElementById('statFurto').innerText=list.filter(i=>i.type==='Furto').length;}function updateCharts(list){const byType={};list.forEach(i=>byType[i.type]=(byType[i.type]||0)+1);chartTypes.data.labels=Object.keys(byType);chartTypes.data.datasets[0].data=Object.values(byType);chartTypes.update();const byRegion={};list.forEach(i=>byRegion[i.region]=(byRegion[i.region]||0)+1);chartRegions.data.labels=Object.keys(byRegion);chartRegions.data.datasets[0].data=Object.values(byRegion);chartRegions.update();}async function addMarkers(list){markers.clearLayers();for(const it of list){if(!(it.lat&&it.lon))continue;const emoji=it.type==='Acidente'?'üöó':(it.type==='Interdi√ß√£o'?'üöß':(it.type==='Roubo'?'üö®':(it.type==='Furto'?'‚ö™':'‚ö†Ô∏è')));const icon=L.divIcon({html:`<div style="background:#0d47a1;color:#fff;border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center">${emoji}</div>`,className:''});const m=L.marker([it.lat,it.lon],{icon}).addTo(markers);m.bindPopup(`<strong>${it.title}</strong><br>${it.source} ‚Ä¢ ${new Date(it.pubDate).toLocaleString()}<br><a href="${it.link}" target="_blank">Ver fonte</a>`);}const layers=markers.getLayers();if(layers.length){const group=L.featureGroup(layers);map.fitBounds(group.getBounds().pad(0.2));}}function applyFilters(items){const q=(searchInput.value||'').toLowerCase();const type=typeSelect.value;const region=regionSelect.value;const rod=rodoviaSelect.value;let filtered=items.filter(i=>{if(q&&(i.title+i.snippet+i.source).toLowerCase().indexOf(q)===-1)return false;if(type&&i.type!==type)return false;if(region&&i.region!==region)return false;if(rod&&rod.length){if(!((i.road&&i.road.indexOf(rod.split('/')[0])!==-1)||(i.title&&i.title.indexOf(rod.split('/')[0])!==-1)))return false;}return true;});renderNews(filtered);updateStats(filtered);updateCharts(filtered);addMarkers(filtered);lastFetch.innerText=nowStr();const used=JSON.parse(localStorage.getItem('congrl_used_sources')||'[]');const fl=document.getElementById('fontesList');fl.innerHTML=used.map(s=>`<div>${s}</div>`).join('')||'<div>Nenhuma fonte ativa</div>'}document.getElementById('btnCSV').addEventListener('click',()=>{const cache=JSON.parse(localStorage.getItem('congrl_cache')||'{"items":[]}');const items=cache.items||[];if(!items.length){alert('Sem dados para exportar');return;}const rows=[['Data Baixada','T√≠tulo','Fonte','Data da Not√≠cia','Link','Tipo','Rodovia']];const now=nowStr();items.forEach(it=>rows.push([now,it.title||'',it.source||'',it.pubDate||'',it.link||'',it.type||'',it.road||'']));const csv=rows.map(r=>r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(';')).join('
');const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='congrl_noticias.csv';a.click();});document.getElementById('btnPDF').addEventListener('click',async()=>{const{jsPDF}=window.jspdf;const doc=new jsPDF();doc.setFontSize(16);doc.text('TORRES - Central Operacional News (CON)',14,20);doc.setFontSize(12);doc.text('Relat√≥rio de not√≠cias ‚Äî '+nowStr(),14,30);const cache=JSON.parse(localStorage.getItem('congrl_cache')||'{"items":[]}');const items=cache.items||[];let y=40;for(let i=0;i<Math.min(10,items.length);i++){const it=items[i];doc.setFontSize(11);doc.text(`${i+1}. ${it.title}`,14,y);y+=6;doc.setFontSize(9);doc.text(`Fonte: ${it.source} ‚Ä¢ ${it.pubDate} ‚Ä¢ Tipo: ${it.type}`,14,y);y+=6;if(y>260){doc.addPage();y=20;}}doc.save('congrl_relatorio.pdf');});function openModal(id){document.getElementById(id).style.display='block'}function closeModal(id){document.getElementById(id).style.display='none'}document.getElementById('ajudaBtn').addEventListener('click',()=>openModal('ajudaModal'));document.getElementById('fontesBtn').addEventListener('click',()=>openModal('fontesModal'));document.getElementById('fontesBuscaBtn').addEventListener('click',()=>openModal('fontesBuscaModal'));document.querySelectorAll('.close').forEach(el=>el.addEventListener('click',e=>closeModal(e.target.dataset.for)));document.querySelectorAll('.btn-close').forEach(el=>el.addEventListener('click',e=>closeModal(e.target.dataset.for)));window.addEventListener('click',function(e){if(e.target.classList.contains('modal'))e.target.style.display='none'});document.getElementById('expandMap').addEventListener('click',()=>{window.open('map.html','_blank')});const all=await fetchFeeds();localStorage.setItem('congrl_cache',JSON.stringify({items:all,fetched:new Date().toISOString()}));applyFilters(all);[typeSelect,regionSelect,rodoviaSelect,searchInput].forEach(el=>{el.addEventListener('change',()=>applyFilters(JSON.parse(localStorage.getItem('congrl_cache')).items));el.addEventListener('input',()=>applyFilters(JSON.parse(localStorage.getItem('congrl_cache')).items));});setInterval(async()=>{const items=await fetchFeeds();localStorage.setItem('congrl_cache',JSON.stringify({items:items,fetched:new Date().toISOString()}));applyFilters(items);},1000*60*30);try{const w=await fetch('https://api.open-meteo.com/v1/forecast?latitude=-23.55&longitude=-46.63&current_weather=true').then(r=>r.json());document.getElementById('weather').innerText=`Temp: ${w.current_weather.temperature}¬∞C ‚Ä¢ Vento: ${w.current_weather.windspeed} m/s`}catch(e){document.getElementById('weather').innerText='Erro ao carregar previs√£o.'}})();